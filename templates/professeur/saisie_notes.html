<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Saisie Notes & Avis - Professeur</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; padding: 20px; }
    .card { max-width: 900px; margin: auto; }
    input, textarea { font-size: 1rem !important; }
  </style>
</head>
<body>
<div class="container">
  <div class="card shadow p-4">
    <h2 class="text-center text-primary mb-4">Saisie Notes & Appréciations</h2>
    
    <div class="mb-3">
      <label>Code élève (ex: 26A0204)</label>
      <input type="text" id="code" class="form-control" placeholder="26A0204">
    </div>

    <div class="mb-3">
      <label>Message public (apparaît sur la page Avis du site)</label>
      <textarea id="avis" class="form-control" rows="3" placeholder="Ex: Bravo à toute la classe pour le travail fourni !"></textarea>
    </div>

    <div class="text-center">
      <button onclick="charger()" class="btn btn-info">Charger l’élève</button>
      <button onclick="sauvegarder()" class="btn btn-success btn-lg">ENREGISTRER TOUT</button>
    </div>

    <div id="resultat" class="mt-4"></div>
    <div id="tableau"></div>
  </div>
</div>

<script>
// Ta config Firebase (la vraie)
const firebaseConfig = {
  apiKey: "AIzaSyCEbcDjcCpxIaLT8x1fOUqZX_M-8olJfrw",
  authDomain: "sjcj-site.firebaseapp.com",
  projectId: "sjcj-site"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

async function charger() {
  const code = document.getElementById("code").value.trim();
  if (!code) return alert("Entre un code élève");
  
  const snap = await db.collection("eleves").doc(code).get();
  if (!snap.exists) return alert("Élève non trouvé");
  
  const data = snap.data();
  document.getElementById("resultat").innerHTML = `<div class="alert alert-success">Élève trouvé : ${data.prenom} ${data.nom} - ${data.classe}</div>`;
  
  // Génère le tableau éditable
  const matieres = {
    "1ere F4": ["FRANÇAIS","ANGLAIS","MATH","PCT","RDM","PE","DESSIN","SMC","TP","METRE","HYGIENE","PC"],
    "2nde F4": ["FRANÇAIS","ANGLAIS","MATH","PHYSIQUE","DESSIN","INFORMATIQUE","TM/TC","TP","MECANIQUE","PREVENTION","LEGIS"],
    "Tle F4": ["FRANÇAIS","ANGLAIS","MATH","PCT","RDM","PE","DESSIN","METRE","PC","BA","TP","LEGIS"],
    "2nde IMI": ["FRANÇAIS","ANGLAIS","MATH","EB","LA","AS","SEV","SER","ALGO","MATH APPLIQUE","LEGIS"],
    "Tle IMI": ["FRANÇAIS","ANGLAIS","MATH","EB","RESEAU","RP","MATH APPLIQUÉ","LEGIS","BD","PG","ELEC"],
    "Tle F3": ["FRANÇAIS","ANGLAIS","MATH","PHYSIQUE","ELECTRO","EST","PRATIQUE","MEL","DESSIN","ANGLAIS"],
    "2nde FC": ["FRANÇAIS","ANGLAIS","MATH","EPS","PHYSIQUE","HIST-GEO","PHYSIQUE APPLIQUE","AUTOMATISME","DESSIN","ELECTRO DE BASE"],
    "1ere HR": ["FRANÇAIS","ANGLAIS","MATH","TC","SAAH","ECONOMAT","TRB","DROIT","MERCATIQUE","COMPTABILITE"],
    "2nde F3": ["FRANÇAIS","ANGLAIS","MATH","PCT","TECHNO","SCHÉMA","DESSIN","ELECTRO","PRATIQUE","MEL"]
  };

  let html = `<table class="table table-bordered mt-3"><thead class="table-dark">
    <tr><th>Matière</th><th>I1</th><th>I2</th><th>I3</th><th>I4</th><th>D1</th><th>D2</th><th>Appréciation</th></tr></thead><tbody>`;
  
  (matieres[data.classe] || []).forEach(m => {
    html += `<tr>
      <td><strong>${m}</strong></td>
      <td><input type="number" min="0" max="20" step="0.1" class="form-control form-control-sm" data-m="${m}" data-f="inter1"></td>
      <td><input type="number" min="0" max="20" step="0.1" class="form-control form-control-sm" data-m="${m}" data-f="inter2"></td>
      <td><input type="number" min="0" max="20" step="0.1" class="form-control form-control-sm" data-m="${m}" data-f="inter3"></td>
      <td><input type="number" min="0" max="20" step="0.1" class="form-control form-control-sm" data-m="${m}" data-f="inter4"></td>
      <td><input type="number" min="0" max="20" step="0.1" class="form-control form-control-sm" data-m="${m}" data-f="devoir1"></td>
      <td><input type="number" min="0" max="20" step="0.1" class="form-control form-control-sm" data-m="${m}" data-f="devoir2"></td>
      <td><input type="text" class="form-control form-control-sm" data-m="${m}" data-f="appreciation"></td>
    </tr>`;
  });
  html += `</tbody></table>`;
  document.getElementById("tableau").innerHTML = html;
}

async function sauvegarder() {
  const code = document.getElementById("code").value.trim();
  const avis = document.getElementById("avis").value.trim();
  if (!code) return alert("Code élève requis");

  const notes = [];
  document.querySelectorAll("#tableau input").forEach(inp => {
    const m = inp.dataset.m;
    const f = inp.dataset.f;
    if (!notes.find(n => n.matiere === m)) {
      notes.push({ matiere: m, inter1: null, inter2: null, inter3: null, inter4: null, devoir1: null, devoir2: null, appreciation: "" });
    }
    const note = notes.find(n => n.matiere === m);
    if (inp.value) note[f] = inp.value;
  });

  await db.collection("eleves").doc(code).update({ notes_S1: notes });
  if (avis) {
    await db.collection("avis").add({
      message: avis,
      date: new Date(),
      auteur: "Professeur"
    });
  }
  alert("Notes + avis enregistrés avec succès !");
}
</script>
</body>
</html>